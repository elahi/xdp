---
title: "Introduction to non-metric multidimensional scaling"
fontfamily: mathpazo
fontsize: 10pt
geometry: margin=0.75in
output:
  html_document:
    css: ../lab.css
    highlight: pygments
    theme: cerulean
    toc: true
    toc_float: true
  pdf_document:
    toc: no
layout: topic
editor_options:
  chunk_output_type: console
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=5, fig.height=3.5, 
                      echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
```

## Getting started

### Load packages


Let's load the packages.

```{r load-packages, message=FALSE, eval = TRUE}
library(MASS)
library(vegan)
#library(labdsv)
library(tidyverse)
theme_set(theme_bw(base_size = 14))

## Define the repository from which we get the data
repo_url <- "https://raw.githubusercontent.com/elahi/phd_elahi/master/northeast_pacific_wall_surveys/data/"
```

### The data

```{r load-data, eval = TRUE}
dat <- read.csv(paste(repo_url, "sjc_sessile_130513_mds.csv", sep = ""))
glimpse(dat)
```

```{r}
dim(dat)
summary(dat)
colnames(dat)
str(dat)

## subset 1009 data (to best match NEPWS sampling)
dat1 <- subset(dat, dat$month=="1009")
dim(dat1)
colnames(dat1)

# create spp matrix (including ON and PG)
abun <- dat1[,13:75]
summary(abun)

# transform matrix
abun.sq <- sqrt(abun)

# presence/absence
abun.pa <- decostand(abun, method="pa")

# create group matrix
group <- dat1[,1:12]

# Perform the NMDS in 2 dimensions on raw data
abun.MDS2 = metaMDS(abun, distance="bray", k=2, engine = 'monoMDS', autotransform=FALSE, noshare=0.1, trymax=40, zerodist='add')
abun.MDS2$stress # stress = 0.225

# Perform the NMDS in 2 dimensions on sqrt data
abun.sq.MDS2 = metaMDS(abun.sq, distance="bray", k=2, engine = 'monoMDS', autotransform=FALSE, noshare=0.1, trymax=40, zerodist='add')
abun.sq.MDS2$stress # stress = 0.236


# Perform the NMDS in 2 dimensions on sqrt data
abun.pa.MDS2 = metaMDS(abun.pa, distance="bray", k=2, engine = 'monoMDS', autotransform=FALSE, noshare=0.1, trymax=40, zerodist='add')
abun.pa.MDS2$stress # stress = 0.241



# plot 3 panels
par(mfrow=c(1,3), pty="s", mar=c(1,1,1,1), oma=c(2,4,2,1))

plot(abun.MDS2$points, col=c(group$site), xaxt='n', yaxt='n', xlab='', ylab='', main="Raw cover")
plot(abun.sq.MDS2$points, col=c(group$site), xaxt='n', yaxt='n', xlab='', ylab='', main="Square root")
plot(abun.pa.MDS2$points, col=c(group$site), xaxt='n', yaxt='n', xlab='', ylab='', main="Presence-Absence")

legend("topright", legend=levels(group$site), pch=1, col=c(1:3), bty='y')


# now do the same for the NEPWS data (pa only)
dat2 <- read.csv(paste(repo_url, "NEPWS_channel_130513.csv", sep = ""), header=TRUE, na.strings="NA")
colnames(dat2)

# create spp matrix (including ON and PG)
abun2 <- dat2[,15:87]
summary(abun2)

# create group matrix
group2 <- dat2[,1:14]
group2

# Perform the NMDS in 2 dimensions on raw data
nepws.MDS2 = metaMDS(abun2, distance="bray", k=2, engine = 'monoMDS', autotransform=FALSE, noshare=0.1, trymax=40, zerodist='add')
nepws.MDS2$stress # stress = 0.264

# compare both PA plots

# par(mfrow=c(1,2), pty="s", mar=c(1,1,1,1), oma=c(2,4,2,1))
# 
# plot(nepws.MDS2$points, col=c(group$site), xaxt='n', yaxt='n', xlab='', ylab='', main="NEPWS")
# legend("topright", legend=levels(group2$site), pch=1, col=c(1:3), bty='y')
# 
# 
# plot(abun.pa.MDS2$points, col=c(group$site), xaxt='n', yaxt='n', xlab='', ylab='', main="Presence-Absence_%Cover")



```



* * *

## More Practice

7.  Mutate the data frame so that it includes a new variable that contains the 
    average speed, `avg_speed` traveled by the plane for each flight (in mph).
    **Hint:** Average speed can be calculated as distance divided by
    number of hours of travel, and note that `air_time` is given in minutes.
    Make a scatterplot of `avg_speed` vs. `distance`. **Hint:** Use `geom_point()`. 
    Describe the relationship between average speed and distance.

8.  Replicate the following plot. **Hint:** The data frame plotted only
    contains flights from American Airlines, Delta Airlines, and United
    Airlines, and the points are `color`ed by `carrier`. Include the code you used to create the plot, 
    as well as the plot itself. 
    <!-- Once you replicate the plot, determine (roughly) what the cutoff point is for departure -->
    <!-- delays where you can still expect to get to your destination on time. -->

```{r plot-to-replicate, echo=FALSE, eval = TRUE, fig.show="asis", fig.width=7, fig.height=4}
# dl_aa_ua <- nycflights %>%
#   filter(carrier == "AA" | carrier == "DL" | carrier == "UA")
# ggplot(data = dl_aa_ua, aes(x = dep_delay, y = arr_delay, color = carrier)) +
#   geom_point()
```

## License  
<div id="license">
Robin Elahi, that is released under a [Creative Commons Attribution-ShareAlike 4.0](http://creativecommons.org/licenses/by-sa/4.0) license.
This lab was adapted from a lab written by..
</div>

